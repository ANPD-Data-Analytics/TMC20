

/******************* For Amazon only items, report on ASIN and force all to NWIC***********************************/

SELECT 	UPC_ASIN,
		MAX(IDX_ITEM) AS IDX_ITEM,
		MIN(ITEM_DESC) AS ITEM_DESC,
		MIN(NIELSEN_DESCRIPTION) AS NIELSEN_DESCRIPTION,
		FULL_UPC,
		NIELSEN_UPC,
		EQ_FACTOR,
		MAX(ABBOTT_PRODUCT) AS ABBOTT_PRODUCT,
		MAX(AN_ITEM_NBR) AS AN_ITEM_NBR,
		MAX(AN_BRAND_FAMILY) AS AN_BRAND_FAMILY,
		MAX(AN_BRAND) AS AN_BRAND,
		MAX(AN_SEGMENT) AS AN_SEGMENT,
		MAX(AN_FORM) AS AN_FORM,
		MAX(AN_FLAVOR) AS AN_FLAVOR,
		MAX(NIELSEN_ABT_MEGA_CATEGORY) AS NIELSEN_ABT_MEGA_CATEGORY,
		MAX(NIELSEN_ABT_SUBSEGMENT) AS NIELSEN_ABT_SUBSEGMENT,
		MAX(NIELSEN_ABT_MANUFACTURER) AS NIELSEN_ABT_MANUFACTURER,
		MAX(NIELSEN_ABT_FORM) AS NIELSEN_ABT_FORM,
		MAX(NIELSEN_ABT_SIZE) AS NIELSEN_ABT_SIZE,
		MAX(NIELSEN_ABT_REBATE) AS NIELSEN_ABT_REBATE,
		MAX(NIELSEN_ABT_CONTAINER) AS NIELSEN_ABT_CONTAINER,
		MAX(NIELSEN_ABT_FLAVOR) AS NIELSEN_ABT_FLAVOR,
		MAX(NIELSEN_ABT_FLAVOR_GROUP) AS NIELSEN_ABT_FLAVOR_GROUP,
		MAX(NIELSEN_ABT_PACK) AS NIELSEN_ABT_PACK,
		MAX(NIELSEN_ABT_FORMULATION) AS NIELSEN_ABT_FORMULATION,
		MAX(NIELSEN_MEGA_CATG) AS NIELSEN_MEGA_CATG,
		MAX(NIELSEN_ABT_FORMULA_TYPE) AS NIELSEN_ABT_FORMULA_TYPE,
		MAX(NIELSEN_CATEGORY) AS NIELSEN_CATEGORY,
		MAX(NIELSEN_SEGMENT) AS NIELSEN_SEGMENT,
		MAX(NIELSEN_SUBSEGMENT) AS NIELSEN_SUBSEGMENT,
		MAX(NIELSEN_MANUFACTURER) AS NIELSEN_MANUFACTURER,
		MAX(NIELSEN_BRAND) AS NIELSEN_BRAND,
		MAX(NIELSEN_SUBBRAND) AS NIELSEN_SUBBRAND,
		MAX(NIELSEN_BRANDLOW) AS NIELSEN_BRANDLOW,
		MAX(NIELSEN_FORM) AS NIELSEN_FORM,
		MAX(NIELSEN_PACK_SIZE) AS NIELSEN_PACK_SIZE,
		MAX(NIELSEN_FLAVOR) AS NIELSEN_FLAVOR,
		MAX(NIELSEN_FLAVOR_GROUP) AS NIELSEN_FLAVOR_GROUP,
		MAX(NIELSEN_ORGANIC_CLAIM) AS NIELSEN_ORGANIC_CLAIM,
		MAX(NIELSEN_FORMULA_TYPE) AS NIELSEN_FORMULA_TYPE,
		MAX(NIELSEN_FORMULASUBTYPE) AS NIELSEN_FORMULASUBTYPE,
		MAX(NIELSEN_FORMULATION) AS NIELSEN_FORMULATION,
		MAX(NIELSEN_VARIANT) AS NIELSEN_VARIANT,
		MAX(NIELSEN_ABT_NAT_ORG) AS NIELSEN_ABT_NAT_ORG,
		MAX(EACHES_PER_SCANNED_ITEM) AS EACHES_PER_SCANNED_ITEM,
		MAX(EACHES_PER_CASE) AS EACHES_PER_CASE,
		MAX(ABT_SIZE_RANGE) AS ABT_SIZE_RANGE,
		MAX(VENDOR_CODE) AS VENDOR_CODE,
		MAX(NIELSEN_ABT_BRAND_FAMILY) AS NIELSEN_ABT_BRAND_FAMILY,
		MAX(NIELSEN_ABT_DIET_GROUP) AS NIELSEN_ABT_DIET_GROUP,
		MAX(NIELSEN_ABT_BRAND_TYPE) AS NIELSEN_ABT_BRAND_TYPE,
		MAX(NIELSEN_ABT_SUBBRAND_GROUP) AS NIELSEN_ABT_SUBBRAND_GROUP,
		MAX(NIELSEN_ABT_BASE_SIZE) AS NIELSEN_ABT_BASE_SIZE,
		MAX(ABT_COUNT_SIZE) AS ABT_COUNT_SIZE,
		MAX(ABT_MULTI) AS ABT_MULTI,
		MAX(AN_WIC_REBATE_PRODUCT) AS AN_WIC_REBATE_PRODUCT

FROM 	(SELECT	CASE 	WHEN IT.NIELSEN_SEGMENT IN ('IFUA', 'INFANT FORMULA UA') AND IT.NIELSEN_ABT_REBATE = 'REBATED' AND CI.CUST_ITEM_NBR LIKE 'B%'	
							THEN CI.CUST_ITEM_NBR	
						WHEN CI.CUST_ITEM_NBR LIKE 'B%' AND IT.NIELSEN_UPC = '000000000000' 	
							THEN CI.CUST_ITEM_NBR	
						WHEN IT.NIELSEN_UPC <> '000000000000' 	
							THEN IT.NIELSEN_UPC	
				END AS UPC_ASIN,
				MAX(IT.IDX_ITEM) AS IDX_ITEM,
				CASE 	WHEN ITEM_DESC IS NOT NULL THEN ITEM_DESC 
						ELSE IT.NIELSEN_DESCRIPTION 
						END AS ITEM_DESC,
				NIELSEN_DESCRIPTION,
				FULL_UPC,
				IT.NIELSEN_UPC,
				EQ_FACTOR,
				ABBOTT_PRODUCT,
				AN_ITEM_NBR,
				AN_BRAND_FAMILY,
				AN_BRAND,
				AN_SEGMENT,
				AN_FORM,
				AN_FLAVOR,
				NIELSEN_ABT_MEGA_CATEGORY,
				NIELSEN_ABT_SUBSEGMENT,
				NIELSEN_ABT_MANUFACTURER,
				NIELSEN_ABT_FORM,
				NIELSEN_ABT_SIZE,
				CASE 	WHEN IT.NIELSEN_ABT_REBATE = 'REBATED' AND IT.NIELSEN_SEGMENT IN ('IFUA', 'INFANT FORMULA UA') THEN 'NON-REBATED' 
						ELSE IT.NIELSEN_ABT_REBATE 
						END as NIELSEN_ABT_REBATE,
				NIELSEN_ABT_CONTAINER,
				NIELSEN_ABT_FLAVOR,
				NIELSEN_ABT_FLAVOR_GROUP,
				NIELSEN_ABT_PACK,
				NIELSEN_ABT_FORMULATION,
				NIELSEN_MEGA_CATG,
				NIELSEN_ABT_FORMULA_TYPE,
				NIELSEN_CATEGORY,
				NIELSEN_SEGMENT,
				NIELSEN_SUBSEGMENT,
				NIELSEN_MANUFACTURER,
				NIELSEN_BRAND,
				NIELSEN_SUBBRAND,
				NIELSEN_BRANDLOW,
				NIELSEN_FORM,
				NIELSEN_PACK_SIZE,
				NIELSEN_FLAVOR,
				NIELSEN_FLAVOR_GROUP,
				NIELSEN_ORGANIC_CLAIM,
				NIELSEN_FORMULA_TYPE,
				NIELSEN_FORMULASUBTYPE,
				NIELSEN_FORMULATION,
				NIELSEN_VARIANT,
				NIELSEN_ABT_NAT_ORG,
				EACHES_PER_SCANNED_ITEM,
				EACHES_PER_CASE,
				ABT_SIZE_RANGE,
				VENDOR_CODE,
				NIELSEN_ABT_BRAND_FAMILY,
				NIELSEN_ABT_DIET_GROUP,
				NIELSEN_ABT_BRAND_TYPE,
				NIELSEN_ABT_SUBBRAND_GROUP,
				NIELSEN_ABT_BASE_SIZE,
				ABT_COUNT_SIZE,
				ABT_MULTI,
				AN_WIC_REBATE_PRODUCT

		FROM 	 AbbottSandbox.dbo.vvItem IT
				,AbbottSandbox.dbo.vvCustomerItem CI
				
		WHERE 	IT.IDX_ITEM = CI.IDX_ITEM
		AND  	CI.IDX_COMPANY = '71'--Amazon OCR has ABT and competitive (71)
		AND 	((IT.NIELSEN_SEGMENT IN ('BALANCED NUTRITION', 'DIABETES NUTRITION', 'TODDLER NUTRITION', 'ORAL ELECTROLYTES', 
										'INFANT FORMULA UA', 'IFUA', 'BN', 'DN', 'OES', 'TN')
				AND 	CI.CUST_ITEM_NBR LIKE 'B%' )
				OR (IT.NIELSEN_SEGMENT IN ('NUTRITIOUS SNACKS', 'WEIGHT MANAGEMENT', 'PERFORMANCE NUTRITION')
					AND IT.NIELSEN_BRAND IN ('ZONE PERFECT'
								, 'LUNA'
								, 'THINK'
								, 'QUEST'
								, 'ONE'
								, 'KIND'
								, 'CLIF'
								, 'POWER CRUNCH'
								, 'ATKINS' 
								, 'RX BAR'
								, 'LARABAR'
								, 'WW PURE PRTN'
								, 'GO MACRO'
								, 'SLMFAST'
								, 'PERFECT')
					AND (	IT.NIELSEN_FORM NOT LIKE '%CHEW%'
							OR IT.NIELSEN_FORM NOT LIKE '%LIQUID%'
							OR IT.NIELSEN_FORM NOT LIKE '%GEL%'
							OR IT.NIELSEN_FORM NOT LIKE '%GUMMY%'
							OR IT.NIELSEN_FORM NOT LIKE '%OIL%'
							OR IT.NIELSEN_FORM NOT LIKE '%PILL%'
							OR IT.NIELSEN_FORM NOT LIKE '%POWDER%'
							OR IT.NIELSEN_FORM NOT LIKE '%REM FORM%'
							OR IT.NIELSEN_FORM NOT LIKE '%SHAKE%'
							OR IT.NIELSEN_FORM NOT LIKE '%SHOT%')
					AND CI.CUST_ITEM_NBR LIKE 'B%'))
	
				
		GROUP BY 	CI.CUST_ITEM_NBR,
					IT.NIELSEN_UPC,
					ITEM_DESC,
					NIELSEN_DESCRIPTION,
					FULL_UPC,
					IT.NIELSEN_UPC,
					EQ_FACTOR,
					ABBOTT_PRODUCT,
					AN_ITEM_NBR,
					AN_BRAND_FAMILY,
					AN_BRAND,
					AN_SEGMENT,
					AN_FORM,
					AN_FLAVOR,
					NIELSEN_ABT_MEGA_CATEGORY,
					NIELSEN_ABT_SUBSEGMENT,
					NIELSEN_ABT_MANUFACTURER,
					NIELSEN_ABT_FORM,
					NIELSEN_ABT_SIZE,
					NIELSEN_ABT_REBATE,
					NIELSEN_ABT_CONTAINER,
					NIELSEN_ABT_FLAVOR,
					NIELSEN_ABT_FLAVOR_GROUP,
					NIELSEN_ABT_PACK,
					NIELSEN_ABT_FORMULATION,
					NIELSEN_MEGA_CATG,
					NIELSEN_ABT_FORMULA_TYPE,
					NIELSEN_CATEGORY,
					NIELSEN_SEGMENT,
					NIELSEN_SUBSEGMENT,
					NIELSEN_MANUFACTURER,
					NIELSEN_BRAND,
					NIELSEN_SUBBRAND,
					NIELSEN_BRANDLOW,
					NIELSEN_FORM,
					NIELSEN_PACK_SIZE,
					NIELSEN_FLAVOR,
					NIELSEN_FLAVOR_GROUP,
					NIELSEN_ORGANIC_CLAIM,
					NIELSEN_FORMULA_TYPE,
					NIELSEN_FORMULASUBTYPE,
					NIELSEN_FORMULATION,
					NIELSEN_VARIANT,
					NIELSEN_ABT_NAT_ORG,
					EACHES_PER_SCANNED_ITEM,
					EACHES_PER_CASE,
					ABT_SIZE_RANGE,
					VENDOR_CODE,
					NIELSEN_ABT_BRAND_FAMILY,
					NIELSEN_ABT_DIET_GROUP,
					NIELSEN_ABT_BRAND_TYPE,
					NIELSEN_ABT_SUBBRAND_GROUP,
					NIELSEN_ABT_BASE_SIZE,
					ABT_COUNT_SIZE,
					ABT_MULTI,
					AN_WIC_REBATE_PRODUCT

		union

		/******************* Extract remaining UPCs in selected Segments, report on UPC, ignore ASIN *********************/

		SELECT	IT.NIELSEN_UPC as UPC_ASIN,
				--CI.CUST_ITEM_NBR,
				MAX(IT.IDX_ITEM) AS IDX_ITEM,
				CASE WHEN ITEM_DESC IS NOT NULL THEN ITEM_DESC ELSE NIELSEN_DESCRIPTION END AS ITEM_DESC,
				NIELSEN_DESCRIPTION,
				FULL_UPC,
				IT.NIELSEN_UPC,
				EQ_FACTOR,
				ABBOTT_PRODUCT,
				AN_ITEM_NBR,
				AN_BRAND_FAMILY,
				AN_BRAND,
				AN_SEGMENT,
				AN_FORM,
				AN_FLAVOR,
				NIELSEN_ABT_MEGA_CATEGORY,
				NIELSEN_ABT_SUBSEGMENT,
				NIELSEN_ABT_MANUFACTURER,
				NIELSEN_ABT_FORM,
				NIELSEN_ABT_SIZE,
				NIELSEN_ABT_REBATE,
				NIELSEN_ABT_CONTAINER,
				NIELSEN_ABT_FLAVOR,
				NIELSEN_ABT_FLAVOR_GROUP,
				NIELSEN_ABT_PACK,
				NIELSEN_ABT_FORMULATION,
				NIELSEN_MEGA_CATG,
				NIELSEN_ABT_FORMULA_TYPE,
				NIELSEN_CATEGORY,
				NIELSEN_SEGMENT,
				NIELSEN_SUBSEGMENT,
				NIELSEN_MANUFACTURER,
				NIELSEN_BRAND,
				NIELSEN_SUBBRAND,
				NIELSEN_BRANDLOW,
				NIELSEN_FORM,
				NIELSEN_PACK_SIZE,
				NIELSEN_FLAVOR,
				NIELSEN_FLAVOR_GROUP,
				NIELSEN_ORGANIC_CLAIM,
				NIELSEN_FORMULA_TYPE,
				NIELSEN_FORMULASUBTYPE,
				NIELSEN_FORMULATION,
				NIELSEN_VARIANT,
				NIELSEN_ABT_NAT_ORG,
				EACHES_PER_SCANNED_ITEM,
				EACHES_PER_CASE,
				ABT_SIZE_RANGE,
				VENDOR_CODE,
				NIELSEN_ABT_BRAND_FAMILY,
				NIELSEN_ABT_DIET_GROUP,
				NIELSEN_ABT_BRAND_TYPE,
				NIELSEN_ABT_SUBBRAND_GROUP,
				NIELSEN_ABT_BASE_SIZE,
				ABT_COUNT_SIZE,
				ABT_MULTI,
				AN_WIC_REBATE_PRODUCT

		FROM 	ABBOTTSANDBOX.DBO.VVITEM IT
				
				LEFT JOIN ABBOTTSANDBOX.DBO.VVCUSTOMERITEM CI 
				
				 ON IT.IDX_ITEM = CI.IDX_ITEM

		WHERE --REMAINING UPCS PER SEGMENT BY DEFINITION
				
				(IT.NIELSEN_SEGMENT IN ('BALANCED NUTRITION', 'DIABETES NUTRITION', 'TODDLER NUTRITION', 'ORAL ELECTROLYTES', 
										'INFANT FORMULA UA', 'IFUA', 'BN', 'DN', 'OES', 'TN')
				AND IT.NIELSEN_UPC <> '000000000000'
				AND CI.IDX_COMPANY IS NOT NULL)
				
				OR (IT.NIELSEN_SEGMENT IN ('NUTRITIOUS SNACKS', 'WEIGHT MANAGEMENT', 'PERFORMANCE NUTRITION')
				AND IT.NIELSEN_BRAND IN ('ZONE PERFECT'
										, 'LUNA'
										, 'THINK'
										, 'QUEST'
										, 'ONE'
										, 'KIND'
										, 'CLIF'
										, 'POWER CRUNCH'
										, 'ATKINS' 
										, 'RX BAR'
										, 'LARABAR'
										, 'WW PURE PRTN'
										, 'GO MACRO'
										, 'SLMFAST'
										, 'PERFECT')
					AND (	IT.NIELSEN_FORM NOT LIKE '%CHEW%'
							OR IT.NIELSEN_FORM NOT LIKE '%LIQUID%'
							OR IT.NIELSEN_FORM NOT LIKE '%GEL%'
							OR IT.NIELSEN_FORM NOT LIKE '%GUMMY%'
							OR IT.NIELSEN_FORM NOT LIKE '%OIL%'
							OR IT.NIELSEN_FORM NOT LIKE '%PILL%'
							OR IT.NIELSEN_FORM NOT LIKE '%POWDER%'
							OR IT.NIELSEN_FORM NOT LIKE '%REM FORM%'
							OR IT.NIELSEN_FORM NOT LIKE '%SHAKE%'
							OR IT.NIELSEN_FORM NOT LIKE '%SHOT%')
				AND IT.NIELSEN_UPC <> '000000000000'
				AND CI.IDX_COMPANY IS NOT NULL)

				
		GROUP BY 	IT.NIELSEN_UPC,
					ITEM_DESC,
					NIELSEN_DESCRIPTION,
					FULL_UPC,
					IT.NIELSEN_UPC,
					EQ_FACTOR,
					ABBOTT_PRODUCT,
					AN_ITEM_NBR,
					AN_BRAND_FAMILY,
					AN_BRAND,
					AN_SEGMENT,
					AN_FORM,
					AN_FLAVOR,
					NIELSEN_ABT_MEGA_CATEGORY,
					NIELSEN_ABT_SUBSEGMENT,
					NIELSEN_ABT_MANUFACTURER,
					NIELSEN_ABT_FORM,
					NIELSEN_ABT_SIZE,
					NIELSEN_ABT_REBATE,
					NIELSEN_ABT_CONTAINER,
					NIELSEN_ABT_FLAVOR,
					NIELSEN_ABT_FLAVOR_GROUP,
					NIELSEN_ABT_PACK,
					NIELSEN_ABT_FORMULATION,
					NIELSEN_MEGA_CATG,
					NIELSEN_ABT_FORMULA_TYPE,
					NIELSEN_CATEGORY,
					NIELSEN_SEGMENT,
					NIELSEN_SUBSEGMENT,
					NIELSEN_MANUFACTURER,
					NIELSEN_BRAND,
					NIELSEN_SUBBRAND,
					NIELSEN_BRANDLOW,
					NIELSEN_FORM,
					NIELSEN_PACK_SIZE,
					NIELSEN_FLAVOR,
					NIELSEN_FLAVOR_GROUP,
					NIELSEN_ORGANIC_CLAIM,
					NIELSEN_FORMULA_TYPE,
					NIELSEN_FORMULASUBTYPE,
					NIELSEN_FORMULATION,
					NIELSEN_VARIANT,
					NIELSEN_ABT_NAT_ORG,
					EACHES_PER_SCANNED_ITEM,
					EACHES_PER_CASE,
					ABT_SIZE_RANGE,
					VENDOR_CODE,
					NIELSEN_ABT_BRAND_FAMILY,
					NIELSEN_ABT_DIET_GROUP,
					NIELSEN_ABT_BRAND_TYPE,
					NIELSEN_ABT_SUBBRAND_GROUP,
					NIELSEN_ABT_BASE_SIZE,
					ABT_COUNT_SIZE,
					ABT_MULTI,
					AN_WIC_REBATE_PRODUCT) A
					
GROUP BY 	UPC_ASIN,
			FULL_UPC,
			NIELSEN_UPC,
			EQ_FACTOR;
